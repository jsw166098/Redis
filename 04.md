
## RDB 복구 

Redis는 로그 파일을 사용하여 데이터를 복구하기 위한 작업을 수행한다. 

1. 로그 파일의 무결성을 검사한다. -> RDB 로그 파일에 기록된 **체크썸**, **Redis 버전**, **RDB 버전** 을 확인을 통해 무결성 검사
2. 로그 파일의 무결성에 이상이 없다면 해당 로그 파일에 기록된 데이터를 북구하는 작업을 수행한다. 만약 무결성에 이상이 있으면 Redis가 종료된다. 

RDB 로그 파일을 사용한 데이터 복구는 RDB 파일에 기록된 모든 데이터에 대하여 순차적으로 진행되며 각각의 데이터에 대한 복구는 다음과 같다. 

1. Redis는 RDB 로그 파일에 기록된 로그 레코드를 읽고, 해당 로그 레코드의 값에 대하여 압축 여부를 확인한다.
2. 해당 로그 레코드의 값이 압축되어 있는 경우, 압축해제 함수를 통해 압축을 해제한 다음, dict에 키-값 데이터를 저장한다. 압축되지 않은 데이터는 dict에 바로 저장된다. 
3. 데이터에 대한 저장이 완료된 이후 Redis는 다음 로그 레코드를 읽고 RDB 로그 파일에 기록된 모든 로그 레코드에 대하여 순차적으로 위의 과정을 반복한다. 

## AOF, RDB 복구 비교

데이터 복구 속도는 RDB가 더 빠르다. 
AOF : 수행했던 명령어를 재실행하여 초기 단계를 수행해야 한다. 또한 하나의 키에 대하여 여러 번의 복구 작업을 수행하게 될 수 있다.
RDB: 데이터를 dict에 바로 저장한다.(단순한 데이터 복구 절차) 하나의 키에 대하여 한 번의 복구 작업만 수행하여 데이터를 복구한다.(적은 수행 횟수의 이점)

 ---

 ## AOF-USE-RDB-PREAMBLE
 
 * AOF와 RDB를 혼합 사용하여 로그 파일을 재구축 한다. 
 * AOF rewrite 기법에서 발생하는 재구축 부하를 개선하기 위해
 * AOF preamble은 AOF rewrite와 동일한 동작 조건을 가진다. 
 * RDB의 이점인 빠른 작업 및 복구 속도를 활용한다. 
 * AOF, RDB를 혼합하여 활용한다. 
 * 데이터 복구시 RDB, AOF 복구 방법 모두 사용한다. 

 1. AOF preamble이 호출되면 RDB 작업을 수행할 **자식 프로세스**를 생성한다. 
 2. 자식 프로세서는 **Temp AOF 파일**을 만든 다음 현재 저장된 데이터셋에 대한 **RDB 로그 레코드**를 기록한다. 이때 메인 프로세스는 사용자로부터 요처된 명령어를 처리하며, 처리한 명령어에 대해 AOF 로깅을 수행한다. AOF rewrite와 마찬가지로 생성된 로그 레코드는 AOF 버퍼와 AOF rewrite버퍼에 중복되어 저장된다.
 3. RDB 작업을 완료한 자식 프로세서는 메인 프로세스로 종료 신호를 전송한다. 
 4. 메인 프로세스는 자식 프로세스를 종료한 다음, AOF Rewrite 버퍼에 저장된 로그 레코드를 Temp AOF 파일에 기록한다(flush 작업). 
 5. flush 작업이 완료되면, Temp AOF 파일의 이름을 AOF 파일로 변경하는 작업을 수행하여 AOF Preamble 작업을 마무리 한다. (AOF preamble 역시 AOF 파일 크기가 이전 작업 종료 시점의 AOF 파일 크기의 2배가 되었을 때 다시 호출한다.)

### 문제
* AOF Rewrite 버퍼에 중복 저장
*  flush 작업 수행!